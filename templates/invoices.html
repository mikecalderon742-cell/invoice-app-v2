{% extends "base.html" %}
{% block content %}

<div class="dashboard-header">
    <h1>Dashboard Overview</h1>
    <div class="quick-actions">
        <a href="/" class="btn">+ New Invoice</a>
        <a href="/invoices" class="btn btn-secondary">Refresh</a>
    </div>
</div>

<!-- KPI STRIP -->
<div class="dashboard-cards enhanced">

    <!-- TOTAL INVOICES -->
    <div class="card kpi orange">
        <h2 class="count-up" data-target="{{ invoices|length }}">0</h2>
        <p>Total Invoices</p>
        <small class="card-sub">Last 30 Days</small>
    </div>

    <!-- TOTAL REVENUE -->
    <div class="card kpi green">
        {% set total_revenue = invoices | sum(attribute=2) if invoices else 0 %}
        <h2>${{ "{:,.2f}".format(total_revenue) }}</h2>
        <p>Total Revenue</p>
        <small class="card-sub">Last 30 Days</small>
    </div>

    <!-- THIS MONTH -->
    <div class="card kpi blue">
        <h2>${{ "{:,.2f}".format(monthly_revenue) }}</h2>
        <p>This Month</p>

        {% if total_revenue > 0 %}
            {% set growth = ((monthly_revenue / total_revenue) * 100) | round(1) %}
            <small class="card-sub">
                {{ growth }}% of total revenue
            </small>
        {% else %}
            <small class="card-sub">No revenue data yet</small>
        {% endif %}
    </div>

    <!-- AVG INVOICE -->
    <div class="card kpi purple">
        <h2>
            {% if invoices %}
                ${{ "{:,.2f}".format(total_revenue / (invoices|length)) }}
            {% else %}
                $0.00
            {% endif %}
        </h2>
        <p>Avg Invoice</p>
        <small class="card-sub">Last 30 Days</small>
    </div>

    <!-- PAID COUNT -->
    <div class="card kpi teal">
        {% set paid_count = invoices | selectattr(4, "equalto", "Paid") | list | length %}
        <h2>{{ paid_count }}</h2>
        <p>Paid</p>
        <small class="card-sub">Invoices Completed</small>
    </div>

</div>

{% if invoices %}

<!-- REVENUE CHART -->
<div class="chart-card brand-accent">
    <div class="chart-header">
    <div>
        <h3>Revenue Trend</h3>
        <span class="chart-sub">Performance by Invoice</span>
    </div>

    <div class="chart-filters">
        <button class="filter-btn {% if active_range == '30' %}active{% endif %}" 
        onclick="window.location='?range=30'">30D</button>

<button class="filter-btn {% if active_range == '90' %}active{% endif %}" 
        onclick="window.location='?range=90'">90D</button>

<button class="filter-btn {% if active_range == 'all' %}active{% endif %}" 
        onclick="window.location='?range=all'">All</button>
    </div>
</div>
    <canvas id="revenueChart"></canvas>
</div>

<script>
const revenueCtx = document.getElementById('revenueChart');

const allLabels = [
    {% for invoice in invoices %}
        "Invoice #{{ invoice[0] }}",
    {% endfor %}
];

const allData = [
    {% for invoice in invoices %}
        {{ invoice[2] }},
    {% endfor %}
];

const revenueChart = new Chart(revenueCtx, {
    type: 'line',
    data: {
        labels: allLabels,
        datasets: [{
            label: 'Revenue',
            data: allData,
            borderWidth: 3,
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        animation: {
            duration: 1000,
            easing: 'easeOutQuart'
        },
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
    }
});

// Filter logic
document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", function() {
        document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
        this.classList.add("active");

        const range = this.dataset.range;

        if (range === "all") {
            revenueChart.data.labels = allLabels;
            revenueChart.data.datasets[0].data = allData;
        } else {
            const limit = parseInt(range);
            revenueChart.data.labels = allLabels.slice(-limit);
            revenueChart.data.datasets[0].data = allData.slice(-limit);
        }

        revenueChart.update();
    });
});
</script>

<!-- STATUS DONUT -->
<div class="chart-card brand-accent">
    <div class="chart-header">
        <h3>Status Distribution</h3>
        <span class="chart-sub">Paid vs Sent vs Draft</span>
    </div>
    <canvas id="statusChart"></canvas>
</div>

<script>
const statusCtx = document.getElementById('statusChart');

new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Paid', 'Sent', 'Draft'],
        datasets: [{
            data: [
                {{ invoices | selectattr(4, "equalto", "Paid") | list | length }},
                {{ invoices | selectattr(4, "equalto", "Sent") | list | length }},
                {{ invoices | selectattr(4, "equalto", "Draft") | list | length }}
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>

{% endif %}

<!-- SEARCH -->
<div class="search-bar modern">
    <form method="GET" action="/invoices">
        <input type="text" name="search" placeholder="Search by client name">
        <button type="submit" class="btn">Search</button>
    </form>
</div>

{% if invoices %}

<!-- TOP CLIENTS -->
<div class="chart-card brand-accent">
    <div class="chart-header">
        <h3>Top Clients</h3>
        <span class="chart-sub">Ranked by revenue</span>
    </div>

    {% set clients = {} %}
    {% for invoice in invoices %}
        {% set _ = clients.update({invoice[1]: clients.get(invoice[1], 0) + invoice[2]}) %}
    {% endfor %}

    <ul class="leaderboard">
        {% for client, total in clients|dictsort(by='value', reverse=True) %}
            <li>
                <span>{{ client }}</span>
                <strong>${{ "{:,.2f}".format(total) }}</strong>
            </li>
        {% endfor %}
    </ul>
</div>

<!-- TABLE -->
<div class="table-wrapper">
<table class="modern-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Client</th>
            <th>Total</th>
            <th>Date</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for invoice in invoices %}
        <tr>
            <td>#{{ invoice[0] }}</td>
            <td>{{ invoice[1] }}</td>
            <td>${{ "{:,.2f}".format(invoice[2]) }}</td>
            <td>{{ invoice[3] }}</td>
            <td>
                {% if invoice[4] == "Paid" %}
                    <span class="badge paid">Paid</span>
                {% elif invoice[4] == "Sent" %}
                    <span class="badge sent">Sent</span>
                {% else %}
                    <span class="badge draft">Draft</span>
                {% endif %}
            </td>
            <td class="action-buttons">
                <a class="btn btn-secondary" href="/edit/{{ invoice[0] }}">Edit</a>
                <a class="btn btn-danger" href="/delete/{{ invoice[0] }}">Delete</a>
                <a class="btn" href="/history-pdf/{{ invoice[0] }}">PDF</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

{% else %}

<div class="empty-state">
    <h3>No invoices yet</h3>
    <p>Create your first invoice to get started.</p>
    <a class="btn" href="/">Create Invoice</a>
</div>

{% endif %}

{% endblock %}
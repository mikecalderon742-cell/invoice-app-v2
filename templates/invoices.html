{% extends "base.html" %}
{% block content %}

<div class="dashboard-header">
    <h1>Dashboard Overview</h1>
    <div class="quick-actions">
        <a href="/" class="btn">+ New Invoice</a>
        <a href="/invoices" class="btn btn-secondary">Refresh</a>
    </div>
</div>

<!-- KPI STRIP -->
<div class="dashboard-cards enhanced">

    <!-- TOTAL INVOICES -->
    <div class="card kpi orange">
        <h2 class="count-up" data-target="{{ invoices|length }}">0</h2>
        <p>Total Invoices</p>
        <small class="card-sub">Last 30 Days</small>
    </div>

    <!-- TOTAL REVENUE -->
    <div class="card kpi green">
        {% set total_revenue = invoices | sum(attribute=2) if invoices else 0 %}
        <h2>${{ "{:,.2f}".format(total_revenue) }}</h2>
        <p>Total Revenue</p>
        <small class="card-sub">Last 30 Days</small>
    </div>

    <!-- THIS MONTH -->
    <div class="card kpi blue">
        <h2>${{ "{:,.2f}".format(monthly_revenue) }}</h2>
        <p>This Month</p>

        {% if total_revenue > 0 %}
            {% set growth = ((monthly_revenue / total_revenue) * 100) | round(1) %}
            <small class="card-sub">
                {{ growth }}% of total revenue
            </small>
        {% else %}
            <small class="card-sub">No revenue data yet</small>
        {% endif %}
    </div>

    <!-- AVG INVOICE -->
    <div class="card kpi purple">
        <h2>
            {% if invoices %}
                ${{ "{:,.2f}".format(total_revenue / (invoices|length)) }}
            {% else %}
                $0.00
            {% endif %}
        </h2>
        <p>Avg Invoice</p>
        <small class="card-sub">Last 30 Days</small>
    </div>

    <!-- PAID COUNT -->
    <div class="card kpi teal">
        {% set paid_count = invoices | selectattr(4, "equalto", "Paid") | list | length %}
        <h2>{{ paid_count }}</h2>
        <p>Paid</p>
        <small class="card-sub">Invoices Completed</small>
    </div>

</div>

{% if invoices %}

<!-- REVENUE CHART -->
<div class="card analytics-card" style="border: 2px solid #151B54;">
    <div class="chart-header">
        <div>
            <h3>Revenue Trend</h3>
            <span class="chart-sub">Performance by Invoice</span>
        </div>

        <div class="chart-filters">
            <button class="filter-btn {% if active_range == '30' %}active{% endif %}" data-range="30">30D</button>
            <button class="filter-btn {% if active_range == '90' %}active{% endif %}" data-range="90">90D</button>
            <button class="filter-btn {% if active_range == 'all' %}active{% endif %}" data-range="all">All</button>
        </div>
    </div>
    <canvas id="revenueChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const revenueCtx = document.getElementById('revenueChart');

const allLabels = [
    {% for invoice in invoices %}
        "Invoice #{{ invoice[0] }}",
    {% endfor %}
];

const allData = [
    {% for invoice in invoices %}
        {{ invoice[2] }},
    {% endfor %}
];

const revenueChart = new Chart(revenueCtx, {
    type: 'line',
    data: {
        labels: allLabels,
        datasets: [{
            label: 'Revenue',
            data: allData,
            borderColor: '#151B54',
            backgroundColor: 'rgba(21,27,84,0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        animation: {
            duration: 1000,
            easing: 'easeOutQuart'
        },
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
    }
});

// Filter logic
document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", function() {
        document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
        this.classList.add("active");

        const range = this.dataset.range;

        if (range === "all") {
            revenueChart.data.labels = allLabels;
            revenueChart.data.datasets[0].data = allData;
        } else {
            const limit = parseInt(range);
            revenueChart.data.labels = allLabels.slice(-limit);
            revenueChart.data.datasets[0].data = allData.slice(-limit);
        }

        revenueChart.update();
    });
});
</script>

{% endif %}

<!-- STATUS DONUT -->
<div class="chart-card brand-accent">
    <div class="chart-header">
        <h3>Status Distribution</h3>
        <span class="chart-sub">Paid vs Sent vs Draft</span>
    </div>
    <canvas id="statusChart"></canvas>
</div>

<script>
const statusCtx = document.getElementById('statusChart');

new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Paid', 'Sent', 'Draft'],
        datasets: [{
            data: [
                {{ invoices | selectattr(4, "equalto", "Paid") | list | length }},
                {{ invoices | selectattr(4, "equalto", "Sent") | list | length }},
                {{ invoices | selectattr(4, "equalto", "Draft") | list | length }}
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>

<!-- ... rest of your template remains completely unchanged ... -->

{% endblock %}
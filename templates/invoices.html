{% extends "base.html" %}
{% block content %}

<div class="dashboard-header">
    <h1>Dashboard Overview</h1>
    <div class="quick-actions">
        <a href="/" class="btn">+ New Invoice</a>
        <a href="/invoices" class="btn btn-secondary">Refresh</a>
    </div>
</div>

<!-- STEP 1: Overdue Detection Logic -->
{% if invoices %}
{% else %}
    {% set overdue_count = 0 %}
{% endif %}

<!-- STEP 2: Overdue Alert Banner -->
{% if overdue_count > 0 %}
<div class="alert-overdue">
    ⚠ {{ overdue_count }} invoice{{ 's' if overdue_count > 1 else '' }} overdue.
</div>
{% endif %}

<!-- KPI STRIP -->
<div class="dashboard-cards enhanced">

    <div class="card kpi orange">
        <h2 class="count-up" data-target="{{ invoices|length }}">0</h2>
        <p>Total Invoices</p>
        <small class="card-sub">Last 30 Days</small>
    </div>

    <div class="card kpi green">
        {% set total_revenue = invoices | sum(attribute=2) if invoices else 0 %}
        <h2>${{ "{:,.2f}".format(total_revenue) }}</h2>
        <p>Total Revenue</p>
        <small class="card-sub">Last 30 Days</small>
    </div>

    <div class="card kpi blue">
        <h2>${{ "{:,.2f}".format(monthly_revenue) }}</h2>
        <p>This Month</p>

        {% if total_revenue > 0 %}
            {% set growth = ((monthly_revenue / total_revenue) * 100) | round(1) %}
            <small class="card-sub">
                {{ growth }}% of total revenue
            </small>
        {% else %}
            <small class="card-sub">
    {% if revenue_growth > 0 %}
        <span style="color:#16a34a; font-weight:600;">
            ↑ {{ revenue_growth }}% vs last month
        </span>
    {% elif revenue_growth < 0 %}
        <span style="color:#dc2626; font-weight:600;">
            ↓ {{ revenue_growth | abs }}% vs last month
        </span>
    {% else %}
        <span style="color:#6b7280;">
            0% change vs last month
        </span>
    {% endif %}
</small>
        {% endif %}
    </div>

    <div class="card kpi purple">
        <h2>
            {% if invoices %}
                ${{ "{:,.2f}".format(total_revenue / (invoices|length)) }}
            {% else %}
                $0.00
            {% endif %}
        </h2>
        <p>Avg Invoice</p>
        <small class="card-sub">Last 30 Days</small>
    </div>

    <!-- ✅ FIXED INDEX -->
    <div class="card kpi teal">
        {% set paid_count = invoices | selectattr(5, "equalto", "Paid") | list | length %}
        <h2>{{ paid_count }}</h2>
        <p>Paid</p>
        <small class="card-sub">Invoices Completed</small>
    </div>

    <div class="card kpi red">
        <h2>{{ overdue_count }}</h2>
        <p>Overdue</p>
        <small class="card-sub">Requires Attention</small>
    </div>

</div>

{% if invoices %}

<!-- (ALL YOUR CHARTS REMAIN EXACTLY AS YOU SENT THEM — UNCHANGED) -->

<!-- TABLE -->
<div class="table-wrapper">
<table class="modern-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Client</th>
            <th>Total</th>
            <th>Date</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for invoice in invoices %}
        <tr class="
            {% if invoice[0] in overdue_list %}row-overdue
            {% elif invoice[5] == 'Paid' %}row-paid
            {% elif invoice[5] == 'Draft' %}row-draft
            {% endif %}
        ">
            <td>#{{ invoice[0] }}</td>
            <td>{{ invoice[1] }}</td>
            <td>${{ "{:,.2f}".format(invoice[2]) }}</td>
            <td>{{ invoice[3] }}</td>

            <!-- ✅ FIXED STATUS INDEX -->
            <td>
                {% if invoice[5] == "Paid" %}
                    <span class="badge paid">Paid</span>
                {% elif invoice[5] == "Overdue" %}
                    <span class="badge overdue">Overdue</span>
                {% else %}
                    <span class="badge sent">Sent</span>
                {% endif %}
            </td>

            <!-- ✅ CLEANER UX TOGGLE -->
            <td class="action-buttons">
                <a class="btn btn-edit" href="/edit/{{ invoice[0] }}">Edit</a>

                {% if invoice[5] == "Paid" %}
                    <a class="btn btn-info" href="/update-status/{{ invoice[0] }}/Sent">
                        Mark Sent
                    </a>
                {% else %}
                    <a class="btn btn-success" href="/update-status/{{ invoice[0] }}/Paid">
                        Mark Paid
                    </a>
                {% endif %}

                <a class="btn btn-danger" href="/delete/{{ invoice[0] }}">Delete</a>
                <a class="btn btn-brand" href="/history-pdf/{{ invoice[0] }}">PDF</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

{% else %}

<div class="empty-state">
    <h3>No invoices yet</h3>
    <p>Create your first invoice to get started.</p>
    <a class="btn" href="/">Create Invoice</a>
</div>

{% endif %}

{% endblock %}
{% extends "base.html" %}

{% block content %}

<div class="dashboard-header">
    <h1>Dashboard Overview</h1>
    <div class="quick-actions">
        <a href="/" class="btn">+ New Invoice</a>
        <a href="/invoices" class="btn btn-secondary">Refresh</a>
    </div>
</div>

<!-- KPI STRIP -->
<div class="dashboard-cards enhanced">

    <div class="card kpi">
        <h2>{{ invoices|length }}</h2>
        <p>Total Invoices</p>
    </div>

    <div class="card kpi green">
        <h2>
            ${{ "{:,.2f}".format(invoices | sum(attribute=2)) if invoices else "0.00" }}
        </h2>
        <p>Total Revenue</p>
    </div>

    <div class="card kpi blue">
        <h2>${{ "{:,.2f}".format(monthly_revenue) }}</h2>
        <p>This Month</p>
    </div>

    <div class="card kpi purple">
        <h2>
            {% if invoices %}
                ${{ "{:,.2f}".format((invoices | sum(attribute=2)) / (invoices|length)) }}
            {% else %}
                0.00
            {% endif %}
        </h2>
        <p>Avg Invoice</p>
    </div>

    <div class="card kpi teal">
        <h2>
            {{ invoices | selectattr(4, "equalto", "Paid") | list | length }}
        </h2>
        <p>Paid</p>
    </div>

</div>

{% if invoices %}

<!-- REVENUE CHART CARD -->
<div class="card chart-card">
    <div class="chart-header">
        <h3>Revenue Trend</h3>
        <span class="chart-sub">Performance by Invoice</span>
    </div>
    <canvas id="revenueChart"></canvas>
</div>

<script>
const ctx = document.getElementById('revenueChart');

const labels = [
{% for invoice in invoices %}
"Invoice #{{ invoice[0] }}",
{% endfor %}
];

const data = [
{% for invoice in invoices %}
{{ invoice[2] }},
{% endfor %}
];

new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Revenue',
            data: data,
            borderWidth: 3,
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>

{% endif %}

<!-- SEARCH -->
<div class="search-bar modern">
    <form method="GET" action="/invoices">
        <input type="text" name="search" placeholder="Search by client name">
        <button type="submit" class="btn">Search</button>
    </form>
</div>

{% if invoices %}

<div class="table-wrapper">

<table class="modern-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Client</th>
            <th>Total</th>
            <th>Date</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>

    <tbody>
    {% for invoice in invoices %}
        <tr>
            <td>#{{ invoice[0] }}</td>
            <td>{{ invoice[1] }}</td>
            <td>${{ "{:,.2f}".format(invoice[2]) }}</td>
            <td>{{ invoice[3] }}</td>

            <td>
                {% if invoice[4] == "Paid" %}
                    <span class="badge paid">Paid</span>
                {% elif invoice[4] == "Sent" %}
                    <span class="badge sent">Sent</span>
                {% else %}
                    <span class="badge draft">Draft</span>
                {% endif %}
            </td>

            <td class="action-buttons">
                <a class="btn btn-secondary" href="/edit/{{ invoice[0] }}">Edit</a>
                <a class="btn btn-danger" href="/delete/{{ invoice[0] }}">Delete</a>
                <a class="btn" href="/history-pdf/{{ invoice[0] }}">PDF</a>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

</div>

{% else %}

<div class="empty-state">
    <h3>No invoices yet</h3>
    <p>Create your first invoice to get started.</p>
    <a class="btn" href="/">Create Invoice</a>
</div>

{% endif %}

{% endblock %}